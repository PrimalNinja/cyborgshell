// CyborgShell v20250307 ===========================================================
// by PrimalNinja of Cyborg Unicorn Pty Ltd. Copyright 2025. All Rights Reserved.

/*jsl:ignore*/

function getGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var h=16*Math.random()|0;return("x"==b?h:h&3|8).toString(16)})}
function parentTabHandler(b){function h(a){var f=a.source||a.originalEvent.source,b=null;try{b=JSON.parse(a.originalEvent.data)}catch(d){}if(null!==b){var l=!0;processArray(c,function(a){if(a.id==b.originid)return l=!1,!0});if(l){a=e;var h={id:b.originid,caption:b.origindescription,window:null,opener:null};e++;c[a]=h;h.window=f}}}function m(a){var b=null;try{b=JSON.parse(a.originalEvent.data)}catch(d){}null!==b&&processArray(c,function(a){"0"!==a.id&&a.id!==b.originid&&a.window.postMessage(JSON.stringify({tabid:"0",
originid:b.originid,origindescription:b.origindescription,queue:b.queue,message:b.message,messagedata:b.messagedata}),"*")})}var a=this,d=getGUID(),c=[];c[0]={id:"0",caption:"Parent",window:b.window,opener:null};var e=1;$(b.window).bind("message",function(a){h(a);m(a);if($.isFunction(b.cbOnBroadcast)){var c=null;try{c=JSON.parse(a.originalEvent.data)}catch(d){}null!==c&&void 0!=c.queue&&b.cbOnBroadcast(c.queue,c.message,c.messagedata)}});a.broadcast=function(a,b,d){processArray(c,function(e){"0"!==
e.id&&e.window.postMessage(JSON.stringify({tabid:"0",originid:"0",origindescription:c[0].caption,queue:a,message:b,messagedata:d}),"*")})};a.canCreateTab=function(){return!0};a.createTab=function(a,b,d){var r=e,l=getGUID();void 0===b&&(b="");void 0===d&&(d="");l={id:l,caption:"Child ("+l+")",window:null,opener:null};e++;c[r]=l;l.window=window.open(a+"?tabid="+l.id+b+d,l.caption);return l.window};a.getHandlerID=function(){return d};a.getTabInfo=function(a){return c[a]};a.getTabs=function(){var a=[];
processArray(c,function(b){a.push({id:b.id,caption:b.caption})});return a};a.ping=function(){a.broadcast("system","ping","ping")}}
function cyborgShell_API(b){function h(a){var b={};return a&&"[object Function]"===b.toString.call(a)}var m=this;this.getGuid=function(){return getGUID()};this.debugObject=function(a,b,c){void 0===b&&(b=!0);void 0===c&&(c="");for(var e in a)if(Object.prototype.hasOwnProperty.call(a,e)){var g=a[e];m.print(c+e+": ");"object"===typeof g&&null!==g?b?m.debugObject(g,b,c+" "):m.print(c+" Object",!1,!0):m.print(c+" "+g,!1,!0)}};this.cls=function(){b.console.clearOutput()};this.errorOutput=function(a){b.console.errorOutput(a)};
this.input=function(a,d){b.console.input(a,d)};this.print=function(a,d,c){b.console.appendOutput(a,d,c)};m.end=function(){b.console.end()};this.stop=function(){b.console.stop()};this.language=function(a){b.console.handleServerCommands("language",0,function(b){h(a)&&a(b)})};this.languages=function(a){b.console.handleServerCommands("languages",0,function(b){h(a)&&a(b)})};this.deleteLocalData=function(a,d){b.console.deleteLocalData(a,function(a){h(d)&&d(a)})};this.loadFile=function(a,d){b.console.loadFile(a,
function(a){h(d)&&d(a)})};this.loadLocalData=function(a,d){b.console.loadLocalData(a,function(a){h(d)&&d(a)})};this.saveFile=function(a,d,c){b.console.saveFile(a,d,function(a){h(c)&&c(a)})};this.saveLocalData=function(a,d,c){b.console.saveLocalData(a,d,function(a){h(c)&&c(a)})};this.createDatabase=function(){void 0===b.Indexes&&(b.Indexes={});void 0===b.Cursors&&(b.Cursors={});void 0===b.TableData&&(b.TableData={})};this.appendTable=function(a,d){b.TableData[a]||(b.TableData[a]=[]);b.TableData[a]=
b.TableData[a].concat(d)};this.createIndex=function(a,d,c){var e={},g=a+"__"+d,f=b.TableData[a];if(void 0===f)m.print("Table "+a+" not found.");else{f.forEach(function(a,b){var c=m.escapeValue(a[d]);e[c]?e[c].push(b):e[c]=[b]});var k={};c?Object.keys(e).sort().forEach(function(a){k[a]=e[a]}):Object.keys(e).sort().reverse().forEach(function(a){k[a]=e[a]});b.Indexes[g]={ascending:c,index:k};b.Cursors[g]={cursor:-1,dataIndex:-1,indexed:!0,value:""}}};this.dropIndex=function(a,d){var c=a+"__"+d;b.Indexes[c]&&
delete b.Indexes[c]};this.escapeValue=function(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")};this.findData=function(a,d,c){var e=!0,g,f=a+"__"+d,e=b.TableData[a],k=c;void 0===k&&(k="");void 0===e?m.print("Table "+a+" not found."):(b.Indexes[f]?0<k.length?(c=this.escapeValue(k),c=b.Indexes[f].index[c],c=void 0!==c?{cursor:0,dataIndex:c[0],indexed:!0,value:k}:{cursor:-1,dataIndex:-1,indexed:!0,value:k}):0<e.length?(e=b.Indexes[f].ascending,c=[],c=e?Object.keys(b.Indexes[f].index).sort():Object.keys(b.Indexes[f].index).sort().reverse(),
c=b.Indexes[f].index[c[0]],c={cursor:0,dataIndex:c[0],indexed:!0,value:""}):c={cursor:-1,dataIndex:-1,indexed:!1,value:k}:0<k.length?(c=e.findIndex(function(a){return a[d]===k}),c={cursor:c,dataIndex:c,indexed:!1,value:k}):c=0<e.length?{cursor:0,dataIndex:0,indexed:!1,value:k}:{cursor:-1,dataIndex:-1,indexed:!1,value:k},b.Cursors[f]=c,-1!==c.dataIndex&&(g=b.TableData[a][c.dataIndex]));return g};this.nextData=function(a,d){var c,e=a+"__"+d,g=b.TableData[a],f=b.Cursors[e];if(void 0===g)m.print("Table "+
a+" not found.");else if(void 0===f)m.print("Cursor for "+a+" not found.");else{if(b.Indexes[e]){var g=[],k=-1,h,l=f.value;if(0<l.length){var g=this.escapeValue(l),n=f.cursor,g=b.Indexes[e].index[g],k=f.dataIndex;void 0!==g?(h=g.indexOf(k)+1,f=h>=g.length?{cursor:-1,dataIndex:-1,indexed:!0,value:l}:{cursor:n,dataIndex:g[h],indexed:!0,value:l}):f={cursor:-1,dataIndex:-1,indexed:!0,value:l}}else{var l=Object.keys(b.Indexes[e].index),p=n=0,k=-1;for(h=f.cursor+1;p<h&&0>k;)for(;n<l.length&&0>k;){for(var g=
b.Indexes[e].index[l[n]],q=0;q<g.length;q++)if(p===h){k=g[q];break}else p++;n++}f=p<h?{cursor:-1,dataIndex:-1,indexed:!0,value:""}:{cursor:h,dataIndex:k,indexed:!0,value:""}}}else g=g.findIndex(function(a,b){return 0<f.value.length?b>f.cursor&&a[d]===f.value:b>f.cursor}),f={cursor:g,dataIndex:g,indexed:!1,value:f.value};b.Cursors[e]=f;-1!==f.dataIndex&&(c=b.TableData[a][f.dataIndex])}return c};this.truncateTable=function(a){b.TableData[a]=[]};this.getTabHandler=function(a){return new parentTabHandler({cbOnBroadcast:a,
window:window})}};
