// Home Computer JavaScript v20250307 ===========================================================
// by PrimalNinja of Cyborg Unicorn Pty Ltd. Copyright 2025. All Rights Reserved.

/*jsl:ignore*/

function hcJS(W,X,Y){function h(a,b,c){void 0===b&&(b=!1);void 0===c&&(c=!1);s.push({rtl:u&&!b,reverse:c,output:a});var d="";p.html("");q(s,function(a){var c="";a.rtl&&(c="rtlo");var b=a.output;a.reverse&&a.rtl&&(b=aa(b));d+='<div class="'+c+'">'+b+"</div>"});p.html(d)}function B(a,b){var c=0,d=0,f=0,e="";q(a,function(a){0<e.length&&(e+="\r\n");var b="";d=v(a.lineCode,!1);f=v(a.lineCode,!0);c+=d;0<c&&(b="\t".repeat(c));var g="";a=a.lineCode.trim();0<a.length&&(g=b+a);e+=g;c+=f});return e}function F(){s=
[];p.html("")}function G(a){document.cookie=a+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/"}function ca(a){var b=L(k[g],a);if(0<=b){var c=a+" "+k[g][b].lineCode.replace(/[ \r\n]+$/,"");setTimeout(function(){w();l.val(c)},0)}else h("Line number out of range.",!1,!0)}function L(a,b){var c=-1,d=0;q(a,function(a){a.lineNumber===b&&(c=d);d++});return c}function v(a,b){var c=0,d=a.trim();if("//"!==d.slice(0,2))if("{"===d.slice(-1)||"["===d.slice(-1)||"("===d)b&&(c=M);else if("}"===d||")"===d||"};"===
d||"];"===d||"}];"===d||"});"===d||"]"===d.slice(-1)||"}]"===d.slice(-2)||"},"===d.slice(0,2)||"],"===d.slice(0,2)||"}],"===d.slice(0,3))b||(c=-M);return c}function N(a){a=a.split(" ");var b="",c=!0;q(a,function(a){c?c=!1:(0<b.length&&(b+=" "),b+=a)});return b}function m(a,b,c,d,f,e,Z,ba){var C="",m="",l="",p="",r="",z="",s="",u=d;void 0===u&&(u=!1);var v=Z;void 0===v&&(v=!1);d=ba;void 0===d&&(d=!1);var w=f;void 0===w&&(w=!1);var x=e;void 0===x&&(x=!1);f=a.split(" ");intRFrom=0;"1file"===b?(C=f[1]||
"",l=f[2]||"",p=f[3]||"",r=f[4]||"",intRFrom=5):"2files"===b?(C=f[1]||"",m=f[2]||"",l=f[3]||"",p=f[4]||"",r=f[5]||"",intRFrom=6):"nofiles"===b&&(l=f[1]||"",p=f[2]||"",r=f[3]||"",intRFrom=4);var y=0;q(f,function(a){y>=intRFrom&&(0<z.length&&(z+=" "),z+=a);y++});d&&(s=B(k[g],!0),t[g]=C);$.post("",{commandline:a,f1:C,f2:m,p1:l,p2:p,p3:r,r:z,content:s},function(b){b=JSON.parse(b);b.actions.includes("invalidate")&&G(D);b.actions.includes("ltr")&&H(!1);b.actions.includes("rtl")&&I(!1);!x&&0<b.error.length&&
h(b.error,!1);!w&&0<b.message.length&&(a.startsWith("help")?h(b.message,!1):a.startsWith("cat")||a.startsWith("dir")||a.startsWith("ls")?(h(b.message,!1),h(b.content,!1)):h(b.message,!1));v&&(s=b.content,k[g]=A(s),t[g]=C);E(c)&&c(b);u||n("handleServerCommands:"+a)})}function E(a){var b={};return a&&"[object Function]"===b.toString.call(a)}function O(a,b){$.post("",{commandline:"load",f1:a,f2:"",p1:"",p2:"",p3:"",r:"",content:""},function(a){a=JSON.parse(a);a.actions.includes("invalidate")&&G(D);E(b)&&
b(a)})}function P(a,b){O(a,function(a){a.actions.includes("ltr")&&H(!1);a.actions.includes("rtl")&&I(!1);0<a.error.length&&h(a.error,!1);0<a.message.length&&h(a.message,!1);E(b)&&b(a)})}function da(a){var b={};if(a){var c=a.indexOf("-");-1!==c&&c!==a.length-1?(a=a.split("-"),b.from=parseInt(a[0],10),b.to=parseInt(a[1],10)):"-"===a.charAt(0)?(b.from=-Infinity,b.to=parseInt(a.substring(1),10)):"-"===a.charAt(a.length-1)?(b.from=parseInt(a.substring(0,a.length-1),10),b.to=Infinity):(b.from=parseInt(a,
10),b.to=parseInt(a,10))}else b.from=-Infinity,b.to=Infinity;return b}function q(a,b){if(null!==a)for(var c=1,d=0,f=!1;!f&&d<a.length;)void 0!==a[d]&&E(b)&&(f=b(a[d],c,d)),c++,d++}function n(a){h("Ready",!1,!0);w()}function aa(a){var b=a.split("\n"),c=0;q(b,function(a){a=a.split("").reverse();for(var f=a.length,e=0;e<f;e++)switch(a[e]){case "(":a[e]=")";break;case ")":a[e]="(";break;case "[":a[e]="]";break;case "]":a[e]="[";break;case "{":a[e]="}";break;case "}":a[e]="{"}a=a.join("");b[c]=a;c++});
return a=strLine=b.join("\n")}function J(a){try{eval("(function(api, globals){"+a+"})(m_objAPI, m_objGlobals);"),n("runJS")}catch(b){h("Error: "+b.message,!1,!0),w()}}function ea(a,b,c){$.post("",{commandline:"save",f1:a,f2:"",p1:"",p2:"",p3:"",r:"",content:b},function(a){a=JSON.parse(a);a.actions.includes("invalidate")&&G(D);E(c)&&c(a)})}function w(){setTimeout(function(){var a=document.querySelector("#ge-container");a.scrollTop=a.scrollHeight-a.clientHeight},100)}function A(a){var b=a.split("\n"),
c=[],d=1,f=10;q(b,function(a){a=a.trim();d===b.length&&0===a.length||(c.push({lineNumber:f,lineCode:a}),f+=10,d++)});return c}function fa(a,b){var c;c="";var d=L(k[g],a);0<=d?(c=b.split(" "),1<c.length?(c=N(b),0<c.trim().length&&(k[g][d].lineCode=c)):k[g].splice(d,1)):(c=N(b),0<c.trim().length&&k[g].push({lineNumber:a,lineCode:c}),k[g].sort(function(a,b){return a.lineNumber-b.lineNumber}));n("cmdAddReplaceDeleteLine")}function Q(){var a=1;h("Files:",!1,!0);q(t,function(b){var c=a.toString().padStart(ga,
" "),d="   ";g+1===a&&(d=" * ");h(c+d+b,!1,!0);a++});h("\n* current file",!1,!0);n("cmdFiles")}function R(a,b){var c=0,d=0,f=0;if(0<a.length){var e=da(b);q(a,function(a){var b=!0,g=a.lineNumber;-Infinity!==e.from&&g<e.from&&(b=!1);Infinity!==e.to&&g>e.to&&(b=!1);if(b){b="";d=v(a.lineCode,!1);f=v(a.lineCode,!0);c+=d;0<c&&(b="\t".repeat(c));var g=g.toString().padStart(ha," "),k="";a=a.lineCode.trim();k=0<a.length?g+"\t"+b+a:g+"\t";h(k,!0);c+=f}})}n("cmdList")}function H(a){u=!1;l.removeClass("rtli");
a&&n("cmdLTR")}function ia(a){if(2<a.length){var b=parseInt(a[1].trim(),10);a=parseInt(a[2].trim(),10);if(0<b&&0<a&&a<=r){var c="",d="",f="",e="",l="",m="";q(k[g],function(a){a.lineNumber<b?(0<c.length&&(c+="\r\n"),l="",m=a.lineCode.trim(),0<m.length&&(l=m),c+=l):(0<d.length&&(d+="\r\n"),l="",m=a.lineCode.trim(),0<m.length&&(l=m),d+=l)});q(k[a-1],function(a){0<f.length&&(f+="\r\n");l="";m=a.lineCode.trim();0<m.length&&(l=m);f+=l});e=c;0<e.length&&(e+="\r\n");e+=f;0<e.length&&(e+="\r\n");k[g]=A(e+
d)}else h("Invalid parameters.",!1,!0)}else h("Missing parameters.",!1,!0);n("cmdFilename")}function S(a){r=1;g=0;k=[[]];t=[x];s=[];m_objGlobals={};u=!1;m_objGlobals.console=T;l.val("");F();U(a)}function I(a){u=!0;l.addClass("rtli");a&&n("cmdRTL")}function ja(a){var b=!0,c="";if(1<a.length){var d=a[1].trim();0<d.length&&(b=!1,P(d,function(a){k[g]=A(a.content);t[g]=d;c=B(k[g],!1);J(c)}))}b&&(c=B(k[g],!1),J(c))}function ka(a){var b=!0;if(1<a.length){var c=a[1].trim(),d=a[2];0<c.length&&P(c,function(a){b=!1;a=A(a.content);
R(a,d)})}b&&n("cmdType")}function U(a){for(var b=D+"=",c=document.cookie.split(";"),d="",f=0;f<c.length;f++){for(var e=c[f];" "===e.charAt(0);)e=e.substring(1);if(0===e.indexOf(b)){d=e.substring(b.length);break}}K("validatecookie "+d,null,a)}function la(a){var b=D;a=a.devicekey;var c=ma,d="";c&&(d=new Date,d.setTime(d.getTime()+864E5*c),d="; expires="+d.toUTCString());document.cookie=b+"="+(a||"")+d+"; path=/";U(!1)}function na(a){0<a.content.length&&h(a.content,!0)}function oa(a){V&&(V=!1,K("startup"))}
function K(a,b,c){b=c;c=a.split(" ");var d=c[0],f=parseInt(d,10);void 0===b&&(b=!1);if(0===d.trim().length)h("");else if(isNaN(f))switch(d){case "beautify":if(1===c.length){a=B(k[g],!1);try{var e=JSON.parse(a);a=JSON.stringify(e,null,2);k[g]=A(a)}catch(l){h("Error: "+l.message,!1,!0)}n("cmdBeautify")}else m(a,"1file");break;case "clear":case "cls":F();n("cmdCLS");break;case "ed":case "edit":e=parseInt(c[1],10);!isNaN(e)&&0<e?ca(e):(h("Invalid line number.",!1,!0),n("cmdEdit"));break;case "file":1<
c.length?(e=parseInt(c[1].trim(),10),1>e?(h("Invalid file number.",!1,!0),n("cmdFile")):e>r?Q():(e--,0>e&&(e=0),g=e,n("cmdFile"))):(h(g+1),n("cmdFile"));break;case "filename":1<c.length&&(e=c[1].trim(),0<e.length?t[g]=e:h(t[g]));n("cmdFilename");break;case "files":Q();break;case "list":R(k[g],c[1]);break;case "ltr":H(!0);break;case "new":k[g]=[];t[g]=x;n("cmdNew");break;case "newfile":k.push([]);t.push(x);g=r;r++;n("cmdNewFile");break;case "paste":ia(c);break;case "renum":k[g]=A(B(k[g],!1));n("cmdRenum");
break;case "reset":S(!1);break;case "rtl":I(!0);break;case "run":ja(c);break;case "type":ka(c);break;case "width":a=$("<span>").css({"font-family":p.css("font-family"),"font-size":p.css("font-size"),visibility:"hidden"}).text("W");p.append(a);e=a.width();a.remove();a=p.width();h(Math.floor(a/e),!1,!0);break;case "startup":m(a,"1file",na);break;case "login":m(a,"nofiles",la,!0);break;case "validatecookie":m(a,"nofiles",oa,b);break;case "device":case "devices":case "language":case "languages":case "cat":case "dir":case "ls":case "spaces":case "about":case "admins":case "alias":case "chpwd":case "password":case "logout":case "offline":case "online":case "register":case "username":case "users":case "grant":case "keys":case "newkey":case "revoke":case "shares":m(a,
"nofiles");break;case "cd":case "chdir":case "cs":case "del":case "delete":case "era":case "help":case "space":m(a,"1file");break;case "load":m(a,"1file",null,!1,!1,!1,!0);break;case "save":m(a,"1file",null,!1,!1,!1,!1,!0);break;case "copy":case "cp":case "mv":case "ren":case "rename":m(a,"2files");break;default:J(a)}else fa(f,a)}var D="hcjsdevicekey",ma=365,ga=3,ha=7,M=1,x="Unnamed File",T=this,l=$(W),p=$(X),V=Y,r=1,g=0,k=[[]],t=[x],s=[],m_objGlobals={},u=!1;m_objGlobals.console=T;m_objAPI=new hcJS_API(m_objGlobals);this.appendOutput=function(a,
b,c){h(a,b,c)};this.clearOutput=function(){F()};this.handleServerCommands=function(a,b,c){m(a,b,c,!0,!0,!0)};this.loadFile=function(a,b){O(a,b)};this.saveFile=function(a,b,c){ea(a,b,c)};this.onResize=function(){w()};this.reset=function(){S(!0);$(document.body).on("click",function(){l.focus()});l.on("keypress",function(a){13===a.which&&(a=l.val(),h(a,!1,!0),K(a),l.val(""))})}};
