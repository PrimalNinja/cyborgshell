// Home Computer JavaScript v20250307 ===========================================================
// by PrimalNinja of Cyborg Unicorn Pty Ltd. Copyright 2025. All Rights Reserved.

/*jsl:ignore*/

function getGUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(b){var l=16*Math.random()|0;return("x"==b?l:l&3|8).toString(16)})}
function parentTabHandler(b){function l(a){var d=a.source||a.originalEvent.source,b=null;try{b=JSON.parse(a.originalEvent.data)}catch(f){}if(null!==b){var k=!0;processArray(c,function(a){if(a.id==b.originid)return k=!1,!0});if(k){a=e;var r={id:b.originid,caption:b.origindescription,window:null,opener:null};e++;c[a]=r;r.window=d}}}function m(a){var d=null;try{d=JSON.parse(a.originalEvent.data)}catch(b){}null!==d&&processArray(c,function(a){"0"!==a.id&&a.id!==d.originid&&a.window.postMessage(JSON.stringify({tabid:"0",
originid:d.originid,origindescription:d.origindescription,queue:d.queue,message:d.message,messagedata:d.messagedata}),"*")})}var a=this,f=getGUID(),c=[];c[0]={id:"0",caption:"Parent",window:b.window,opener:null};var e=1;$(b.window).bind("message",function(a){l(a);m(a);if($.isFunction(b.cbOnBroadcast)){var c=null;try{c=JSON.parse(a.originalEvent.data)}catch(e){}null!==c&&void 0!=c.queue&&b.cbOnBroadcast(c.queue,c.message,c.messagedata)}});a.broadcast=function(a,b,e){processArray(c,function(f){"0"!==
f.id&&f.window.postMessage(JSON.stringify({tabid:"0",originid:"0",origindescription:c[0].caption,queue:a,message:b,messagedata:e}),"*")})};a.canCreateTab=function(){return!0};a.createTab=function(a,b,f){var n=e,k=getGUID();void 0===b&&(b="");void 0===f&&(f="");k={id:k,caption:"Child ("+k+")",window:null,opener:null};e++;c[n]=k;k.window=window.open(a+"?tabid="+k.id+b+f,k.caption);return k.window};a.getHandlerID=function(){return f};a.getTabInfo=function(a){return c[a]};a.getTabs=function(){var a=[];
processArray(c,function(c){a.push({id:c.id,caption:c.caption})});return a};a.ping=function(){a.broadcast("system","ping","ping")}}
function hcJS_API(b){function l(a){var b={};return a&&"[object Function]"===b.toString.call(a)}var m=this;this.getGuid=function(){return getGUID()};this.debugObject=function(a,b,c){void 0===b&&(b=!0);void 0===c&&(c="");for(var e in a)if(Object.prototype.hasOwnProperty.call(a,e)){var g=a[e];m.print(c+e+": ");"object"===typeof g&&null!==g?b?m.debugObject(g,b,c+" "):m.print(c+" Object",!1,!0):m.print(c+" "+g,!1,!0)}};this.cls=function(){b.console.clearOutput()};this.print=function(a,f,c){b.console.appendOutput(a,
f,c)};this.language=function(a){b.console.handleServerCommands("language","nofiles",function(b){l(a)&&a(b)})};this.languages=function(a){b.console.handleServerCommands("languages","nofiles",function(b){l(a)&&a(b)})};this.loadFile=function(a,f){b.console.loadFile(a,function(a){l(f)&&f(a)})};this.saveFile=function(a,f,c){b.console.saveFile(a,f,function(a){l(c)&&c(a)})};this.createDatabase=function(){void 0===b.Indexes&&(b.Indexes={});void 0===b.Cursors&&(b.Cursors={});void 0===b.TableData&&(b.TableData=
{})};this.appendTable=function(a,f){b.TableData[a]||(b.TableData[a]=[]);b.TableData[a]=b.TableData[a].concat(f)};this.createIndex=function(a,f,c){var e={},g=a+"__"+f,d=b.TableData[a];if(void 0===d)m.print("Table "+a+" not found.");else{d.forEach(function(a,b){var c=m.escapeValue(a[f]);e[c]?e[c].push(b):e[c]=[b]});var h={};c?Object.keys(e).sort().forEach(function(a){h[a]=e[a]}):Object.keys(e).sort().reverse().forEach(function(a){h[a]=e[a]});b.Indexes[g]={ascending:c,index:h};b.Cursors[g]={cursor:-1,
dataIndex:-1,indexed:!0,value:""}}};this.dropIndex=function(a,f){var c=a+"__"+f;b.Indexes[c]&&delete b.Indexes[c]};this.escapeValue=function(a){return a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")};this.findData=function(a,f,c){var e=!0,g,d=a+"__"+f,e=b.TableData[a],h=c;void 0===h&&(h="");void 0===e?m.print("Table "+a+" not found."):(b.Indexes[d]?0<h.length?(c=this.escapeValue(h),c=b.Indexes[d].index[c],c=void 0!==c?{cursor:0,dataIndex:c[0],indexed:!0,value:h}:{cursor:-1,dataIndex:-1,indexed:!0,value:h}):
0<e.length?(e=b.Indexes[d].ascending,c=[],c=e?Object.keys(b.Indexes[d].index).sort():Object.keys(b.Indexes[d].index).sort().reverse(),c=b.Indexes[d].index[c[0]],c={cursor:0,dataIndex:c[0],indexed:!0,value:""}):c={cursor:-1,dataIndex:-1,indexed:!1,value:h}:0<h.length?(c=e.findIndex(function(a){return a[f]===h}),c={cursor:c,dataIndex:c,indexed:!1,value:h}):c=0<e.length?{cursor:0,dataIndex:0,indexed:!1,value:h}:{cursor:-1,dataIndex:-1,indexed:!1,value:h},b.Cursors[d]=c,-1!==c.dataIndex&&(g=b.TableData[a][c.dataIndex]));
return g};this.nextData=function(a,f){var c,e=a+"__"+f,g=b.TableData[a],d=b.Cursors[e];if(void 0===g)m.print("Table "+a+" not found.");else if(void 0===d)m.print("Cursor for "+a+" not found.");else{if(b.Indexes[e]){var g=[],h=-1,n,k=d.value;if(0<k.length){var g=this.escapeValue(k),l=d.cursor,g=b.Indexes[e].index[g],h=d.dataIndex;void 0!==g?(n=g.indexOf(h)+1,d=n>=g.length?{cursor:-1,dataIndex:-1,indexed:!0,value:k}:{cursor:l,dataIndex:g[n],indexed:!0,value:k}):d={cursor:-1,dataIndex:-1,indexed:!0,
value:k}}else{var k=Object.keys(b.Indexes[e].index),p=l=0,h=-1;for(n=d.cursor+1;p<n&&0>h;)for(;l<k.length&&0>h;){for(var g=b.Indexes[e].index[k[l]],q=0;q<g.length;q++)if(p===n){h=g[q];break}else p++;l++}d=p<n?{cursor:-1,dataIndex:-1,indexed:!0,value:""}:{cursor:n,dataIndex:h,indexed:!0,value:""}}}else g=g.findIndex(function(a,b){return 0<d.value.length?b>d.cursor&&a[f]===d.value:b>d.cursor}),d={cursor:g,dataIndex:g,indexed:!1,value:d.value};b.Cursors[e]=d;-1!==d.dataIndex&&(c=b.TableData[a][d.dataIndex])}return c};
this.truncateTable=function(a){b.TableData[a]=[]};this.getTabHandler=function(a){return new parentTabHandler({cbOnBroadcast:a,window:window})}};
